---
title: 利用多台虚拟机搭建一个Kubernetes集群
date: '2023-04-18'
tags: ['架构', 'Kubernetes']
draft: true
summary: Kubernetes深入学习的第一步，利用多台虚拟机搭建一个Kubernetes集群
---

<h3>为什么要用虚拟机组集群</h3>
最近一直想造一个自己的k8s集群，供给自己瞎折腾，简单想了一下，大概有如下几种途径：

- 真实的拥有两台电脑：受限于财力问题，不太好实现。
- 在云服务提供商上买两台 server：一方面需要花钱，因为这两台 server 和用于代理的 server 不同，我对它们有一定的性能要求（例如 CPU>=2 Core, Memory >= 8GB），会带来不菲的支出，另一方面我希望这两台 server 在物理上距离足够近，并且我对这两台 server 有完全的控制权，云服务商不一定能满足条件。
- 使用 minikube, k3d 等工具在单机上部署一台 server。这些方法会对 k8s 的一些特性做简化，导致与非 toy 版的 k8s 有细微的区别。
- 使用 VirtualBox 创建两台虚拟机组成集群。这种方法可以满足我的所有上述需求，鉴于我有一台高性能计算机的条件下，不需要额外花钱；我对这两台虚拟机有绝对的处置权；在这两台虚拟机上部署的 k8s 非常接近真实的集群，可以供我做一些实验。

综合以上思考，我最终决定使用虚拟机的方式来组 k8s 集群。

本篇博客作为学习 k8s 的第一步，主要介绍如何创建虚拟机、配置网络，并不会涉及到 k8s 相关的内容，这篇博客的主要目的是：

- 在 VirtualBox 上创建两台 Ubuntu Server
- 配置这两台 Server 的网络，使之能够正常上网，并且与宿主机处于同一网络空间
- 附加目的：为了避免在后续使用过程中遇到被墙的问题，为这两台 Server 配置代理

<h3>初始化：在VirtualBox上创建两台Ubuntu虚拟机</h3>

首先，在[VirtualBox 官网](https://www.virtualbox.org/wiki/Downloads)下载最新版的软件并安装；在[Ubuntu 官网](https://ubuntu.com/download/server)下载 Ubuntu 22.04 的镜像（为了性能考虑，下载 Server 版本而不是 Desktop 版本）。

接下来，启动 VirtualBox，按照说明一步步安装镜像即可，启动虚拟机之后，还需要像装系统一样做一些 set up 的操作，过于简单不再赘述。

<h3>配置网络</h3>
在配置网络的过程中，我有几个目的想达成：
1. 两台server在同一网络空间中，可以互相访问。没什么好解释的。
2. 两台server可以正常访问外网(能ping通baidu)。也没什么好解释的。
3. 宿主机与这两台server也处于同一网络空间中，使得能够ssh到这两台server。这是因为虚拟机自带的命令行太丑了，我希望能用宿主机上的一个更漂亮的terminal。

VirtualBox 提供了几种可选的网络模式：

1. Host-Only 模式。这种模式下两台 Server 与宿主机在同一个网络空间中，但是两台 Server 不能上网，只能通过宿主机做代理上网。pass
2. Internal 模式。两台 Server 不能上网。pass
3. NAT 模式。两台 server 处于同一网络空间中，virtualBox 可以看作是一个 NAT 路由器，每个由虚拟机发往外面的请求都会被转化成 virtualBox 这个应用发出的普通的请求（源 ip 为宿主机 ip）。这种方式可以满足目的 1 和 2，不能满足 3.因为宿主机与虚拟机之间相隔一个 NAT 路由器，宿主机无法访问虚拟机。
4. Bridged 模式。这个模式下虚拟机中会创建一张虚拟网卡，并且与宿主机的一张网卡桥接。这样虚拟机与宿主机就处于同一个网络空间下，并且它的行为与同一网络空间的一台真实的物理机相同，例如它和宿主机的网关、DHCP 服务器是相同的，对于网关、DHCP 服务器来说，它并不是虚拟机，而是一台普通的物理机。
