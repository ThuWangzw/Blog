---
title: 2022秋招八股文笔记《操作系统5-文件系统》
date: '2022-06-19'
tags: ['操作系统', '笔记', '秋招', '八股文']
draft: false
summary: 2022秋招八股文笔记《操作系统5-文件系统》
---

1. 文件系统的基本组成
   1. 每个文件有两个相关的数据结构，分别是 inode(文件的索引节点)和 dentry(文件的目录项)
   2. inode 记录的是文件的元信息，包括 inode 编号、文件大小、权限、读写时间、文件在磁盘中的位置。inode 是与文件一一对应的。
   3. dentry 包括文件名、inode 的指针以及与其它 dentry 的层级关系，多个 dentry 关联起来构成了目录结构，但是 dentry 与索引节点不同的是，dentry 是缓存在内存中的数据结构。
   4. 多个目录项可以指向同一个 inode 节点，这也是硬链接的实现。
   5. 区分目录和目录项(dentry)：
      1. 目录是一种特殊的文件，普通文件的内容是文件中的数据，目录文件的内容是它的子目录和其它文件
      2. 目录项是已经打开过的目录或文件的缓存，因为频繁的访问这些文件、目录会频繁进行磁盘的读写，性能比较差。
   6. 文件数据在磁盘上的格式 1. 磁盘读写的最小单位是扇区，512B，linux 读写的最小单位是一个逻辑块，4k，8 个扇区 2. 在实际中，索引节点也会被读入内存 3. 磁盘包括三个区域 1) 超级块：块大小、块数量、空闲块等等 2) 索引节点区 3) 数据块区 4. 磁盘中的超级块在文件系统挂载时进入内存，索引节点的数据在对应的文件被访问时进入内存
      ![filesystem1](/static/images/filesystem1.png)
2. 文件的使用
   1. 使用系统调用 open-write-close 来进行文件读写
   2. 对于每个进程，操作系统维护了一个文件描述符的列表，包括一个打开标志和文件描述符的指针。
   3. 同时，在操作系统层面，维护了一张全进程公用的文件打开表，表项的内容是
      1. inode 指针，指向的是 inode 的内存地址【因为 inode 已经缓存到内存中
      2. 当前读写的指针
      3. 访问权限，操作系统通过这个权限来决定能否通过用户的读写请求
      4. 文件打开的计数器，当计数为 0 时，该项会从文件打开表中删除
3. 文件的存储，文件在磁盘中的存储包括两种方式，分别是连续空间存放方式和非连续空间存放方式【链表方式、索引方式】
   1. 连续空间存放方式
      1. 文件在磁盘中连续存放，读写效率高，一次磁盘的寻道就可以读写整个文件
      2. 文件头（即 inode）中存文件在磁盘中的开始指针和长度即可
      3. 两个明显的缺陷
         1. 磁盘空间碎片：当文件被删除时，会在磁盘中留下空缺，如果新文件的大小比所有空缺都大，就找不到合适的空间。此时可以挪动所有文件，把碎片合并起来，但是效率非常低。
         2. 文件长度不易扩展
   2. 非连续空间存放方式，包括链表方式和索引方式
      1. 链表方式，包括隐式存放和显式存放
         1. 隐式链表：inode 中记录链表的头节点和尾节点的地址，中间每个节点开辟一个区域存放下一个节点的地址。
            a) 隐式存放的第一个缺点是不支持随机读写，只能顺序访问；第二个缺点是稳定性较差，如果链表指针损坏，文件数据就会丢失。
         2. 显式链表：整个磁盘维护一张表，每个表项记录对于当前数据块的下一个数据块指针。这个表格称为文件分配表 FAT。
            a) 显式链表的整张 FAT 都是放在内存中的，避免了隐式链表中多次读写磁盘，检索速度大大提高（解决了隐式链表的第一个问题）
            b) 但是正是由于 FAT 存在内存中，因此不适合大磁盘
      2. 索引方式，索引的方式是给每个文件一个索引数据块（占据一整个数据块），这一块相当于一个目录，文件中的每个数据块都记录在目录中。
         1. 相比于显示链表，因为对每个文件有一张表，因此可以支持大磁盘。
         2. 缺点：如果文件非常小，索引还是要占据一块
         3. 如果文件很大，导致一个索引数据块存不下，那么需要链表索引或者多级索引
   3. unix 使用的存放方式
      1. unix 的 inode 中有 13 个指针
         1. 前 10 个指针表示前 10 个数据块的位置，因此如果文件存放少于 10 个数据块，那么可以直接查找。
         2. 第 11 个指针表示索引数据块的位置，如果 1 个索引数据块不够的话，第 12、13 个指针分别是二级、三级索引数据块的位置
      2. 这个方案用于 ext2/3 中，ext4 中不再使用这种方式，因为对于大文件的读取仍需要多次访问磁盘
4. 空闲空间管理
   1. 前面的文件在磁盘中的存储已经解决了文件在磁盘中的组织结构，但是没有解决文件存放时如何找空闲块写入的问题。
   2. 空闲表法
      1. 对于所有的空闲区域，维护一张空闲表，每个表项记录了空闲区域的地址和空闲块的个数。当操作系统创建文件、删除文件时都会更新这张表。
      2. 当空闲块的个数较少时比较好，否则空闲块太多，导致表变得很大。因此不适合大的文件系统
   3. 空闲链表法
      1. 每个空闲块都有一个指针，指向下一个空闲块，内存中存储第一个空闲块
      2. 不支持随机访问，维护空闲链表时需要大量的读写磁盘。因此不适合大的文件系统。
   4. 位图法
      1. 使用二进制的一个 bit 来表示该块是否空闲。
      2. linux 不仅使用位图法来维护空闲空间，还使用位图法进行 inode 的管理
5. 文件系统的存储
   1. 前面讲的是文件系统中一个文件的存储，那么整个文件系统是如何存储的呢？
   2. 首先，操作系统使用位图来管理空闲的数据块，也使用位图来管理 inode 区域，一个位图使用一个完整的数据块，经过计算，一个位图最多可以表示 128M 的数据，这称为一个块组。磁盘就是一个引导块+一系列的块组组成的。
   3. 每个块组的内容包括
      1. 超级块：整个文件系统的 inode 数量、块的数量、每个块组的 inode 数量、块数量
      2. 块组描述符：每个块组的状态：空闲块、空闲 inode 的数量
      3. 数据位图、inode 位图
      4. 数据块、inode 列表
   4. 注意到每个块组中的超级块和块组描述符块都是全局信息且非常重要，所以会在每个块组中重复。除此之外，是为了使文件和管理数据接近，减少磁盘寻道次数。Ext2 之后采取了稀疏技术，不再存到每个块组中。
      ![filesystem2](/static/images/filesystem2.png)
6. 目录的存储
   1. 目录本身也是文件，存储的是目录下的子目录和文件，是一个列表，每一项是文件的名称、inode 编号等信息。
   2. 但是当目录中的文件非常多时，使用列表存储就非常耗时，可以使用哈希表
7. 硬链接与软链接
   1. 硬链接：创建一个文件，和原文件指向一个 inode。不能跨文件系统。删除文件时，当删除掉源文件和所有的硬链接时，才会真正删除该文件
   2. 软链接：是一个独立的 inode，只是记录了原文件的地址。可以跨文件系统。
8. 文件 IO
   1. 缓冲 IO 与非缓冲 IO：是否利用标准库缓冲（还是在用户态）
   2. 直接 IO 与非直接 IO：系统内核有无缓冲，系统调用有 O_DIRECT 参数，设置后即为直接 IO，默认为非直接 IO
   3. 阻塞 IO 与非阻塞 IO：IO 读写时分为两步，第一步是磁盘数据写入到内核，第二步是内核写入到用户态。阻塞 IO 在第一步阻塞，非阻塞 IO 在第一步不阻塞，但是两种都在第二步是同步操作。也就是说，阻塞 IO 与非阻塞 IO 都是同步 IO。
      1. 同样的，还有 IO 多路复用，实际上是同步的阻塞 IO，只不过第一步可以同时等待多个数据准备好。
   4. 同步与异步 IO：真正的异步 IO 是前两步都不需要等待，等数据准备好之后再通知用户
